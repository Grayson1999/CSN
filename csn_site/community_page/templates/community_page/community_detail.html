{% extends 'main_page/base.html' %}

{% block head_title %}
CSN - {{ post.title }}
{% endblock %}

{% block extra_link %}
<script type="text/javascript">
    function del(pk) {
        var tOrF = confirm("정말 삭제하시겠습니까?")
        if (tOrF) {
            alert("삭제되었습니다.")
            var f = document.update_delete
            f.method = "post"
            f.action = 'http://127.0.0.1:8000/community/post_delete/' + pk + '/'
            f.submit()
        }
    }
</script>
{% endblock %}

{% block main_area %}
        <!-- Page content-->
        <div class="container mt-5">
            <div class="row">
                <div class="col-lg-12">
                    <!-- Post content-->
                    <article>
                        <!-- Post header-->
                        <header class="mb-4">
                            {% if user.is_authenticated and user == post.author %}
                            <form name="update_delete">
                                {% csrf_token %}
                                <div class="row" style="padding-right:20px;">
                                    <div class="update_delete_post_button" style="padding:5px; text-align: right;">
                                        <!-- Post Edit Button -->
                                        <a class="btn btn-sm btn-success" href="/community/post_update/{{ post.pk }}/" id="update_post_button" >수정하기</a>
                                        <!-- Post Delete Button -->
                                        <a class="btn btn-sm btn-danger" id="delete_post_button" onclick="del({{post.pk}})">삭제하기</a>
                                    </div>
                                </div>
                            </form>
                            
                            {% endif %}
                            <!-- Post title-->
                            <h1 class="fw-bolder mb-1">{{ post.title }}</h1>
                            <!-- Post meta content-->
                            <div class="text-muted mb-2">{{ post.author }}&nbsp;&nbsp;{{ post.created_at }}</div>
                            <!-- Post Tags-->
                            <h6>
                                {% if post.tags.exists %}
                                    <div style="text-align: right;">
                                        <i class="fa-solid fa-location-dot"></i>
                                        {% for tag in post.tags.iterator %}
                                            <a><span class="badge badge-pill badge-light" style="color:black;">{{ tag }}</span></a>
                                        {% endfor %}
                                    </div>
                                {% else %}
                                <br>
                                {% endif %}
                            </h6>
                        </header>
                        <!-- {% for photo in post.photo_set.all %}
                            <img src="{{photo.image.url}}" alt="image_error" width="50"><br>
                        {% endfor %} -->
                        <!-- Post content-->
                        <section class="mb-5">
                            <p class="fs-5 mb-4">{{ post.content | safe }}</p>
                        </section>
                    </article>
                    <!-- Comments section-->
                    <section class="mb-5" >
                        <div class="card bg-light">
                            <div class = "container mt-2">
                                <!-- <a href="{% url 'post_like' post.id %}"> -->                                
                                {% if user in post.like_user_set.all %}
                                    {% if user.is_authenticated %}
                                        <a href="{% url 'post_like' post.id %}"><i class="fas fa-heart">{{ post.like_count }}개</i></a>
                                    {% else %}
                                        <a href="{% url 'common:login' %}" onclick="alert('로그인이 필요한 서비스입니다.')"><i class="fas fa-heart">{{ post.like_count }}개</i></a>
                                    {% endif %}
                                {% else %}
                                    {% if user.is_authenticated %}
                                    <a href="{% url 'post_like' post.id %}"><i class="far fa-heart">{{ post.like_count }}개</i></a>
                                    {% else %}
                                    <a href="{% url 'common:login' %}" onclick="alert('로그인이 필요한 서비스입니다.')"><i class="far fa-heart">{{ post.like_count }}개</i></a>
                                    {% endif %}
                                {% endif %}
                            <!-- </a> -->
                            </div>
                            <div class="card-body">
                                <div class="fw-bold">
                                    <h4 style="margin-bottom: 15px;"><b>&nbsp;댓글</b></h4>
                                </div>
                                
                                <!-- Comment form-->
                                {% if user.is_authenticated %}
                                    <form id="comment-form" method="POST" action="{{post.get_absolute_url}}new_comment/">
                                        {% csrf_token %}
                                        <div class="form-group">
                                            <textarea class="form-control" name="content" id="id_content" required="" rows="3" placeholder="댓글을 작성해보세요~!"></textarea>
                                        </div>
                                        <div style="float: right;">
                                            <br>
                                            <button type="submit" class="btn btn-secondary">작성</button>
                                        </div>
                                    </form>
                                {% else %}
                                    <div class="form-group">
                                        <textarea class="form-control" rows="3" placeholder="로그인을 해야 이용 가능한 기능입니다." disabled></textarea>
                                    </div>
                                    <div style="float: right;">
                                        <br>
                                        <button type="submit" class="btn btn-secondary" disabled>작성</button>
                                    </div>
                                {% endif %}
                                {% if post.comment_set.exists %}
                                <div style="margin-top: 75px;">
                                    <hr>
                                    {% for comment in post.comment_set.iterator %}
                                    <!-- Single comment-->
                                    <div class="d-flex" id="comment-{{comment.pk}}">
                                        <div class="flex-shrink-0"><img class="rounded-circle" src="https://dummyimage.com/50x50/ced4da/6c757d.jpg" alt="..." /></div>
                                        <div class="ms-3">
                                            <div class="fw-bold">{{comment.author.username}}&nbsp;&nbsp;
                                                <small class="text-muted">{{comment.created_at}}
                                                    {% if user.is_authenticated and user == comment.author %}
                                                        &nbsp;
                                                        <!-- <form name="comment_update"> -->
                                                            <a role="button"
                                                               id="comment-{{comment.pk}}-update-btn"
                                                               href="/community/comment_update/{{comment.pk}}/">
                                                                <i class="fa-solid fa-pen"></i>
                                                            </a>
                                                            &nbsp;
                                                            <a role="button"
                                                               href="#"
                                                               id="comment-{{comment.pk}}-delete-modal-btn"
                                                               data-bs-toggle="modal" data-bs-target="#deleteCommentModal-{{ comment.pk }}">
                                                               <i class="fa-solid fa-trash-can"></i>
                                                            </a>

                                                            <!-- Modal -->
                                                            <div class="modal fade" id="deleteCommentModal-{{ comment.pk }}" tabindex="-1" role="dialog" aria-labelledby="deleteCommentModalLabel" aria-hidden="true">
                                                                <div class="modal-dialog" role="document">
                                                                    <div class="modal-content">
                                                                        <div class="modal-header">
                                                                            <h5 class="modal-title" id="deleteModalLabel">정말 삭제하시겠습니까?</h5>
                                                                            <button type="button" class="close" data-bs-dismiss="modal" aria-label="Close">
                                                                                <span aria-hidden="true">&times;</span>
                                                                            </button>
                                                                        </div>
                                                                        <div class="modal-body">
                                                                            <del>{{ comment.content | linebreaks }}</del>
                                                                        </div>
                                                                        <div class="modal-footer">
                                                                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                                                                            <a role="button" class="btn btn-danger" href="/community/comment_delete/{{ comment.pk }}/">확인</a>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            {% if comment.created_at != comment.modified_at %}<small>&nbsp;&nbsp;수정됨</small>{% endif %}
                                                        <!-- </form> -->
                                                    {% endif %}
                                                </small>
                                            </div>
                                            {{comment.content | linebreaks}}
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </section>
                </div>
            </div>
        </div>

{% endblock %}